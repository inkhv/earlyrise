## HANDOFF ‚Äî 2026-01-11

### –ö–æ–Ω—Ç–µ–∫—Å—Ç / —Ü–µ–ª—å
–î–æ–±–∞–≤–∏–ª–∏ —Å—Ü–µ–Ω–∞—Ä–∏–π ‚Äú–æ–ø–ª–∞—Ç–∞ ‚Üí —Å—Ä–æ–∫ –¥–æ—Å—Ç—É–ø–∞ ‚Üí –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è/–∫–∏–∫ –∏–∑ —á–∞—Ç–∞ ‚Üí –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–∏—è‚Äù, –±–µ–∑ –ø–æ–¥–ø–∏—Å–æ–∫/–∞–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏–π.

### –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å (prod)
- **Git SHA (main)**: `0ff244b` (–∞–¥–º–∏–Ω–∫–∞: –ø–ª–∞—Ç–µ–∂–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ) ‚Üí –¥–∞–ª–µ–µ `b0e29f5` (view) ‚Üí –¥–∞–ª–µ–µ `04e24b8`/`06feb1c` (fallback –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º)  
- **VPS —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–ª–∏ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ**, –∞–∫—Ç—É–∞–ª—å–Ω—ã–π SHA —Å–º–æ—Ç—Ä–∏–º –∫–æ–º–∞–Ω–¥–æ–π: `cd /opt/earlyrise && git rev-parse --short HEAD`
- **VPS**: –∫–æ–¥ –∑–∞–¥–µ–ø–ª–æ–µ–Ω, —Å–µ—Ä–≤–∏—Å—ã `earlyrise-api` –∏ `earlyrise-bot` –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã –∏ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `active`.

### –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
- **–ù–æ–≤—ã–µ —Ç–∞—Ä–∏—Ñ—ã** (–±–æ—Ç + API):
  - 30 –¥–Ω–µ–π ‚Äî 490 ‚ÇΩ (`plan_code=d30`)
  - 60 –¥–Ω–µ–π ‚Äî 890 ‚ÇΩ (`plan_code=d60`)
  - 90 –¥–Ω–µ–π ‚Äî 1400 ‚ÇΩ (`plan_code=d90`)
  - –Ω–∞–≤—Å–µ–≥–¥–∞ (–ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–µ–∫—Ç) ‚Äî 3000 ‚ÇΩ (`plan_code=life`)
- **–û–∫–æ–Ω—á–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞**:
  - API —Å—á–∏—Ç–∞–µ—Ç `paid_until` (best-effort) –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ `payments` (–ø–æ `plan_code`, –∞ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ ‚Äî –ø–æ —Å—É–º–º–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏).
  - –í `/bot/me` –¥–æ–±–∞–≤–ª–µ–Ω —Å—Ç–∞—Ç—É—Å `expired` (–µ—Å–ª–∏ –±—ã–ª–∏ paid-–ø–ª–∞—Ç–µ–∂–∏, –Ω–æ —Å—Ä–æ–∫ —É–∂–µ –∏—Å—Ç—ë–∫).
  - –ë–æ—Ç –≤ —Å—Ç–∞—Ç—É—Å–µ `expired`:
    - –±–ª–æ–∫–∏—Ä—É–µ—Ç —á–µ–∫‚Äë–∏–Ω—ã (DM text/voice)
    - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫—É **¬´–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —É—á–∞—Å—Ç–∏–µ¬ª** ‚Üí –º–µ–Ω—é –æ–ø–ª–∞—Ç—ã.
- **–°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã (–æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ)**:
  - –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ ‚Äúpaid‚Äù –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω–≤–∞–π—Ç–æ–º –≤ –æ–±—â–∏–π —á–∞—Ç:
    - `https://t.me/+_9uHztv4J7MxMWNi`
  - –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ `wallet_ledger.reason = chat_invite_sent:<challenge_id>`.
- **Cron-–ª–æ–≥–∏–∫–∞ (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ admin endpoint)**:
  - –î–æ–±–∞–≤–ª–µ–Ω `POST /admin/subscriptions/run`
  - –ß—Ç–æ –¥–µ–ª–∞–µ—Ç:
    - –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ **–∑–∞ 2 –¥–Ω—è** –¥–æ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞ (DM)
    - —Å–æ–æ–±—â–µ–Ω–∏–µ **–≤ –¥–µ–Ω—å –æ–∫–æ–Ω—á–∞–Ω–∏—è** (DM) + –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç `participations.left_at` (—á—Ç–æ–±—ã —Å—á–∏—Ç–∞–ª—Å—è ‚Äú–Ω–µ —É—á–∞—Å—Ç–Ω–∏–∫‚Äù)
    - **–Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å** —É–¥–∞–ª—è–µ—Ç –∏–∑ —á–∞—Ç–∞ (ban 60 —Å–µ–∫ + unban) ‚Äî —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—Å—Ç—É–ø–∏—Ç—å —Å–Ω–æ–≤–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
  - –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:
    - –µ—Å–ª–∏ –≤ –ë–î –Ω–µ—Ç –Ω–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫, –º–∞—Ä–∫–µ—Ä—ã –ø–∏—à—É—Ç—Å—è –≤ `wallet_ledger` (`sub:*`)
    - –µ—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∏ –µ—Å—Ç—å ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è `users.*_sent_at` / `users.kicked_from_chat_at` (best-effort).

### –í–∞–∂–Ω—ã–µ env / –∫–æ–Ω—Ñ–∏–≥
- **`MAIN_CHAT_ID`**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ id –æ–±—â–µ–≥–æ —á–∞—Ç–∞ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —á—Ç–æ ‚Äú–æ–∫‚Äù).
- **`ADMIN_DASHBOARD_TOKEN`**:
  - –≤—ã—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ VPS –≤ `/opt/earlyrise/deploy/env.runtime` (—á—Ç–æ–±—ã **–Ω–µ –ø–µ—Ä–µ—Ç–∏—Ä–∞–ª—Å—è –¥–µ–ø–ª–æ–µ–º –∏–∑ git**)
  - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤—Å–µ—Ö `/admin/*` —á–µ—Ä–µ–∑ header `x-admin-token`.
  - –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ **–Ω–µ —Ö—Ä–∞–Ω–∏—Ç—å** –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.
- **`EARLYRISE_PUBLIC_CHAT_INVITE_URL`**:
  - –≤—ã—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ VPS –≤ `/opt/earlyrise/deploy/env.runtime` (–∏ fallback –≤ –∫–æ–¥–µ)
  - fallback –≤ –∫–æ–¥–µ: `https://t.me/+_9uHztv4J7MxMWNi`
 - **systemd drop-in**:
  - `/etc/systemd/system/earlyrise-api.service.d/override.conf` –∏ `/etc/systemd/system/earlyrise-bot.service.d/override.conf` –ø–æ–¥–∫–ª—é—á–∞—é—Ç `EnvironmentFile=/opt/earlyrise/deploy/env.runtime`.

### –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±—ã—Å—Ç—Ä–æ
- **–ú–µ–Ω—é –æ–ø–ª–∞—Ç—ã**:
  - –≤ –±–æ—Ç–µ: `/menu` ‚Üí ‚Äúüí≥ –û–ø–ª–∞—Ç–∏—Ç—å —É—á–∞—Å—Ç–∏–µ‚Äù ‚Üí 4 —Ç–∞—Ä–∏—Ñ–∞.
- **–°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç**:
  - –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã: –æ—Ç–∫—Ä—ã—Ç—å `/menu` ‚Üí –¥–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å—Å—ã–ª–∫–æ–π –Ω–∞ —á–∞—Ç (–æ–¥–∏–Ω —Ä–∞–∑).
- **Cron dry-run**:
  - `POST /admin/subscriptions/run` —Å `{"dry_run": true}` + header `x-admin-token: <ADMIN_DASHBOARD_TOKEN>`
  - –≤–µ—Ä–Ω—ë—Ç —Å—á—ë—Ç—á–∏–∫–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –∏ –æ—à–∏–±–æ–∫, –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—è/–Ω–µ –∫–∏–∫–∞—è.
 - **–ê–¥–º–∏–Ω–∫–∞ (UI)**:
  - (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ) —á–µ—Ä–µ–∑ SSH-—Ç—É–Ω–Ω–µ–ª—å –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ: `ssh -L 3001:127.0.0.1:3001 root@194.67.84.159`
  - –æ—Ç–∫—Ä—ã—Ç—å `http://127.0.0.1:3001/admin/dashboard` –∏ –≤–≤–µ—Å—Ç–∏ `ADMIN_DASHBOARD_TOKEN`.

### –û–ø–ª–∞—Ç—ã: –≤–∞–∂–Ω—ã–µ –±–∞–≥—Ñ–∏–∫—Å—ã —Å–µ–≥–æ–¥–Ω—è
- **Supabase schema drift**:
  - –≤ –ø—Ä–æ–¥–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫–æ–ª–æ–Ω–∫–∏ `payments.plan_code`, `payments.access_days` –∏ –¥—Ä. ‚Üí –¥–æ–±–∞–≤–ª–µ–Ω—ã fallback‚Äô–∏ –≤ API, —á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞—Ç—å –∏ –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ–ø–ª–∞—Ç—É.
  - `getPaidAccessInfo()` —Ç–µ–ø–µ—Ä—å –¥–µ–ª–∞–µ—Ç select —Å `plan_code`, –∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ ‚Äúcolumn missing / schema cache‚Äù –ø–∞–¥–∞–µ—Ç –Ω–∞ select –±–µ–∑ `plan_code`.
  - insert –≤ `payments` –ø—Ä–∏ –æ—à–∏–±–∫–µ ‚Äúschema cache / column missing‚Äù –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π.
- **–ê–¥–º–∏–Ω–∫–∞**:
  - –≤ `/admin/user/:id` –¥–æ–±–∞–≤–ª–µ–Ω –±–ª–æ–∫ **‚Äú–ü–ª–∞—Ç–µ–∂–∏ (50)‚Äù**, –∞ `/admin/user/:id/data` –æ—Ç–¥–∞—ë—Ç `payments` (—Å fallback –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –Ω–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫).
- **Supabase view –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞**:
  - —Å–æ–∑–¥–∞–Ω–æ view `public.payments_with_user` (payments + `@username`/telegram_user_id + challenge_title) ‚Äî –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤ Table Editor.

### n8n / T‚ÄëBank: —Å—Ç–∞—Ç—É—Å–Ω–∞—è –ª–æ–≥–∏–∫–∞ (–≤–∞–∂–Ω–æ)
- –¢‚Äë–ë–∞–Ω–∫ –º–æ–∂–µ—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å —Å—Ç–∞—Ç—É—Å—ã –Ω–µ –ø–æ –ø–æ—Ä—è–¥–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä `CONFIRMED`, –ø–æ—Ç–æ–º —Ä–µ—Ç—Ä–∞–π `AUTHORIZED`).
- –ß—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ ‚Äúpaid ‚Üí pending‚Äù:
  - –≤ Code node –Ω—É–∂–Ω–æ –æ—Ç–¥–∞–≤–∞—Ç—å `should_patch` –∏ **–Ω–µ –¥–µ–ª–∞—Ç—å PATCH** –Ω–∞ `AUTHORIZED` (—Ç–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ: `CONFIRMED/REFUNDED/REJECTED/CANCELED`).
  - –ø–æ—Å–ª–µ Code node –ø–æ—Å—Ç–∞–≤–∏—Ç—å IF `{{$json.should_patch}} is true` ‚Üí —Ç–æ–≥–¥–∞ —Ç–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –ø–∏—à—É—Ç –≤ Supabase.

### –§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–µ–Ω—è–ª–∏—Å—å —Å–µ–≥–æ–¥–Ω—è (–∫–ª—é—á–µ–≤—ã–µ)
- `apps/bot/src/handlers/menu.ts` ‚Äî —Ç–∞—Ä–∏—Ñ—ã + UI –¥–ª—è `expired` (‚Äú–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —É—á–∞—Å—Ç–∏–µ‚Äù)
- `apps/bot/src/handlers/dm.ts` ‚Äî –±–ª–æ–∫ —á–µ–∫‚Äë–∏–Ω–æ–≤ –¥–ª—è `expired`
- `apps/api/src/routes/checkin.ts` ‚Äî —Ç–∞—Ä–∏—Ñ—ã + `expired` + chat invite offer
- `apps/api/src/routes/admin.ts` ‚Äî `POST /admin/subscriptions/run` + ban/unban helpers
- `apps/api/src/config.ts` ‚Äî env: `ADMIN_DASHBOARD_TOKEN`, `MAIN_CHAT_ID`, `EARLYRISE_PUBLIC_CHAT_INVITE_URL`
- `supabase/migrations/20260111000300_payments_with_user_view.sql` ‚Äî view –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π —Å –Ω–∏–∫–∞–º–∏

### –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è / —á—Ç–æ –¥–∞–ª—å—à–µ
- –ú–∏–≥—Ä–∞—Ü–∏—è Supabase —á–µ—Ä–µ–∑ MCP —Å–µ–≥–æ–¥–Ω—è –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∞—Å—å (timeout). –ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äúbest-effort‚Äù –∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –Ω–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫, –Ω–æ –∫–æ–ª–æ–Ω–∫–∏ –ø–æ–ª–µ–∑–Ω—ã –¥–ª—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏.
- –ï—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è ‚Äú–∂—ë—Å—Ç–∫–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø‚Äù –ø–æ–º–∏–º–æ –±–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö) ‚Äî –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `expired` –∏ —Ç–∞–º.

