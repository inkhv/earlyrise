## Автопродление / подписки (T‑Банк) — заметки на будущее

Сейчас в проекте реализована **разовая оплата** через `/bot/pay/create` + вебхуки (через n8n) → обновление `payments.status`.

Если захочешь **автопродление**, это будет не “ещё одна ссылка на оплату”, а **рекуррентные платежи** (привязка карты при первом платеже + последующие списания по сохранённому идентификатору).

### Как это обычно работает (в целом)
- **Первый платёж**: пользователь оплачивает сам, при этом в платёжной системе должна быть включена возможность “привязать карту для повторных списаний”.
- **Webhook**: Т‑Банк присылает статусы (например, `AUTHORIZED` → `CONFIRMED`, а при возврате — `REFUNDED`). Webhooks: `https://developer.tbank.ru/docs/intro/webhooks/`.
- После первого успешного платежа провайдер даёт **идентификатор для повторных списаний** (в разных интеграциях он может называться вроде `RebillId`/`CustomerKey`/`CardId` — зависит от настроек/продукта).
- **Автосписание**: по расписанию система сама инициирует списание по этому идентификатору.
- **Отмена подписки**: пользователь просит отменить → мы помечаем подписку как отменённую и **не инициируем следующее списание** (плюс можно “отвязать” у провайдера, если у него есть отдельная операция).

### Что нужно со стороны Т‑Банка (без этого не стартовать)
- В кабинете эквайринга нужно включить **рекуррентные платежи** (автосписания).
- Уточнить по документации/поддержке:
  - какое поле выдаётся для повторных списаний (условный `RebillId`)
  - каким методом инициируется повторное списание (условный “charge”)
  - как отменяется/отвязывается подписка (если поддерживается)
  - требования к чекам/ОФД/полям (если применимо)

### Как это лучше встроить в EarlyRise (предложение)
- **DB** (новая таблица):
  - `subscriptions`:
    - `user_id`, `challenge_id`
    - `plan_code` (`m1|m2|m3`)
    - `status` (`active|cancelled|past_due`)
    - `paid_until` (timestamptz)
    - `next_charge_at` (timestamptz)
    - `provider_recurring_id` (строка: то, что нужно для повторного списания)
    - `last_provider_payment_id` (например `tbank:...`)
- **Webhook → продление доступа**:
  - При `CONFIRMED`:
    - продлить `paid_until` на период тарифа (1/2/3 месяца)
    - выставить `next_charge_at = paid_until - N дней` (например, за 3 дня до конца)
  - При `REFUNDED`:
    - пометить подписку/доступ как неактивный
    - бот уже умеет показывать уведомление о возврате через `GET /bot/me` (см. `PROJECT_STATE_NEW.md`)
- **Cron** (ежедневно/каждые N часов):
  - выбрать подписки `active` с `next_charge_at <= now`
  - инициировать повторное списание через API Т‑Банка
  - по результату обновить `payments` и `subscriptions`
- **Бот-команды**:
  - `/cancel` — отмена автопродления (не трогаем текущий оплаченный период)
  - `/resume` — включить обратно

### Риски/важное
- Это платёжный контур: лучше не хранить секреты в коде/файлах; использовать Secrets и ротацию.
- Повторные списания почти всегда требуют юридических/документальных настроек (оферта, чек, уведомления).

