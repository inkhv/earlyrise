# Bot спецификация (MVP) — EarlyRise / BTA

Бот — **тонкий клиент** на grammY. Вся бизнес‑логика и работа с БД — через `apps/api`.

## Основные функции

- `/start`: регистрация (upsert пользователя), краткая справка.
- `/join`: вступить в активный челлендж (создаёт `participations`).
- `/me`: быстрые статы (timezone, streak, total checkins, last checkin).
- `/settz <IANA>`: установить таймзону (пример: `Europe/Amsterdam`).
- **Check-in текстом**: если попал в окно чек‑ина → создаём запись `checkins`.
- **Check-in голосом**: скачать голос из Telegram → конвертировать (ffmpeg) → STT (NHN) → сохранить transcript → создать `checkins` → отправить короткий фидбек.

## Новая механика: напарники (buddy system)

### Что делает для пользователя
Пользователь может включить режим **“нужен напарник”**. Бот подбирает пару:
- **основной матч**: напарник с **тем же часовым поясом** и **тем же временем подъёма**;
- если такого нет — предлагает альтернативу:
  - **fallback матч**: другой часовой пояс, но **тот же “момент подъёма”** (совпадение по UTC‑времени; см. алгоритм);
  - либо постановка в **лист ожидания**, и когда появится точный матч — бот предложит “заключить партнёрство”.

### Жёсткое правило
После создания пары: **они зависят друг от друга**.
- Если выбывает один (leave / бан / дисквалификация / не выполнил условия), **выбывают оба**.  
Это правило реализуется **в API**: операция “выбыл” атомарно закрывает обе `participations` и переводит `buddy_pairs` в `inactive`.

### Данные в БД (что мы храним)
Миграция: `supabase/migrations/20251216000200_buddies.sql`
- `participations.wake_time_local` — время подъёма в локальной таймзоне.
- `participations.wake_utc_minutes` — “время подъёма” в минутах UTC (для кросс‑таймзон матчей; вычисляет API).
- `buddy_pairs` — активные пары (по челленджу).
- `buddy_waitlist` — лист ожидания.

### Алгоритм подбора (MVP)

Вход: `challenge_id`, `user_id`, `timezone`, `wake_time_local`.

1) **Подготовка**:
   - сохраняем/обновляем `participations.wake_time_local`
   - вычисляем `wake_utc_minutes`:
     - берём ближайшее наступление `wake_time_local` в таймзоне пользователя (обычно “завтра/сегодня”),
     - переводим в UTC,
     - берём минуту суток \(0..1439\).

2) **Primary match** (точный):
   - ищем в этом же `challenge_id` кандидата:
     - `left_at IS NULL`
     - не состоит в активной паре
     - `timezone == user.timezone` (из `users.timezone`)
     - `wake_time_local == user.wake_time_local`

3) **Fallback match** (кросс‑таймзона):
   - ищем кандидата с тем же `wake_utc_minutes`
   - (опционально позже) допускаем погрешность ±5 минут

4) **Если матч найден**:
   - создаём `buddy_pairs(status='active')`
   - удаляем записи из `buddy_waitlist` для обоих участников (если были)
   - бот отправляет обоим сообщение: “у вас напарник, теперь вы связаны; если выбывает один — выбывают оба”.

5) **Если матча нет**:
   - создаём/обновляем `buddy_waitlist` для участия
   - бот предлагает варианты: ждать точного матча или согласиться на fallback (если позже введём явный “opt‑in”).

### Поведение при уходе/выбывании
API делает:
- находит `buddy_pairs` где участие пользователя присутствует и `status='active'`
- проставляет `left_at` у **обоих** `participations`
- переводит `buddy_pairs.status='inactive'`
- (опционально) создаёт системную запись/лог причины

## Ручное назначение напарников (через админку)

В админке нужен инструмент:
- выбрать `challenge`
- найти 2 участника
- назначить пару вручную (создаёт `buddy_pairs`)
- снять пару (inactive)

Эта операция проходит через `apps/api` и требует admin auth.






